detect:
  events:
  - NEW_PROCESS
  - EXISTING_PROCESS
  op: and
  rules:
  - op: is windows
  - op: or
    rules:
    - op: and
      rules:
      - op: or
        rules:
        - case sensitive: false
          op: contains
          path: event/PARENT/FILE_PATH
          value: C:\Windows\Temp
        - case sensitive: false
          op: contains
          path: event/PARENT/FILE_PATH
          value: \hpqhvind.exe
      - case sensitive: false
        op: matches
        path: event/FILE_PATH
        re: ^(?:(?:.:)|(?:\\Device\\HarddiskVolume.))\\ProgramData\\DRM
    - op: and
      rules:
      - case sensitive: false
        op: starts with
        path: event/PARENT/FILE_PATH
        value: C:\ProgramData\DRM
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \wmplayer.exe
    - op: and
      rules:
      - case sensitive: false
        op: ends with
        path: event/PARENT/FILE_PATH
        value: \Test.exe
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \wmplayer.exe
    - case sensitive: false
      op: is
      path: event/FILE_PATH
      value: C:\ProgramData\DRM\CLR\CLR.exe
    - op: and
      rules:
      - case sensitive: false
        op: starts with
        path: event/PARENT/FILE_PATH
        value: C:\ProgramData\DRM\Windows
      - case sensitive: false
        op: ends with
        path: event/FILE_PATH
        value: \SearchFilterHost.exe
respond:
- action: report
  metadata:
    author: Florian Roth, Markus Neis
    description: Detects specific process characteristics of Winnti malware noticed
      in Dec/Jan 2020 in a campaign against Honk Kong universities
    falsepositives:
    - Unlikely
    level: critical
    references:
    - https://www.welivesecurity.com/2020/01/31/winnti-group-targeting-universities-hong-kong/
    tags:
    - attack.defense_evasion
    - attack.t1073
    - attack.g0044
    - attack.t1574.002
  name: Winnti Malware HK University Campaign

