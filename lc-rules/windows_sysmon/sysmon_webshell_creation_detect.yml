detect:
  log type: wel
  op: or
  rules:
  - op: or
    rules:
    - op: and
      rules:
      - op: and
        rules:
        - case sensitive: false
          op: is
          path: Event/System/EventID
          value: '11'
        - case sensitive: false
          op: contains
          path: Event/EventData/TargetFilename
          value: \inetpub\wwwroot\
        - op: or
          rules:
          - case sensitive: false
            op: contains
            path: Event/EventData/TargetFilename
            value: .asp
          - case sensitive: false
            op: contains
            path: Event/EventData/TargetFilename
            value: .ashx
          - case sensitive: false
            op: contains
            path: Event/EventData/TargetFilename
            value: .ph
      - not: true
        op: or
        rules:
        - case sensitive: false
          op: contains
          path: Event/EventData/TargetFilename
          value: \AppData\Local\Temp\
        - case sensitive: false
          op: contains
          path: Event/EventData/TargetFilename
          value: \Windows\Temp\
    - op: and
      rules:
      - op: and
        rules:
        - case sensitive: false
          op: is
          path: Event/System/EventID
          value: '11'
        - op: or
          rules:
          - case sensitive: false
            op: contains
            path: Event/EventData/TargetFilename
            value: \www\
          - case sensitive: false
            op: contains
            path: Event/EventData/TargetFilename
            value: \htdocs\
          - case sensitive: false
            op: contains
            path: Event/EventData/TargetFilename
            value: \html\
        - case sensitive: false
          op: contains
          path: Event/EventData/TargetFilename
          value: .ph
      - not: true
        op: or
        rules:
        - case sensitive: false
          op: contains
          path: Event/EventData/TargetFilename
          value: \AppData\Local\Temp\
        - case sensitive: false
          op: contains
          path: Event/EventData/TargetFilename
          value: \Windows\Temp\
  - op: and
    rules:
    - op: and
      rules:
      - case sensitive: false
        op: is
        path: Event/System/EventID
        value: '11'
      - op: or
        rules:
        - case sensitive: false
          op: ends with
          path: Event/EventData/TargetFilename
          value: .jsp
        - op: and
          rules:
          - case sensitive: false
            op: contains
            path: Event/EventData/TargetFilename
            value: \cgi-bin\
          - case sensitive: false
            op: contains
            path: Event/EventData/TargetFilename
            value: .pl
    - not: true
      op: or
      rules:
      - case sensitive: false
        op: contains
        path: Event/EventData/TargetFilename
        value: \AppData\Local\Temp\
      - case sensitive: false
        op: contains
        path: Event/EventData/TargetFilename
        value: \Windows\Temp\
  target: log
respond:
- action: report
  metadata:
    author: Beyu Denis, oscd.community
    description: Possible webshell file creation on a static web site
    falsepositives:
    - Legitimate administrator or developer creating legitimate executable files in
      a web application folder
    level: critical
    references:
    - PT ESC rule and personal experience
    tags:
    - attack.persistence
    - attack.t1100
    - attack.t1505.003
  name: Windows Webshell Creation

